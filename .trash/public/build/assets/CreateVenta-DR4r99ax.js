import{r as n,b as N,j as e,H as re,a as y}from"./app-OZZRvyqe.js";import{A as ne}from"./AuthenticatedLayout-D2-JfW7j.js";import{A as oe}from"./arrow-left-De8lAmq5.js";import{T as A}from"./trending-down-C5u-TA3Z.js";import{T as le}from"./triangle-alert-DBa2wIfJ.js";import{S as E}from"./search-YP_qfHty.js";import{S as D,C as ce}from"./square-check-big-m0AXRLkr.js";import{S as L}from"./square-Br0YAtzX.js";import{F as T}from"./file-minus-Bfvj0vcz.js";import"./createLucideIcon-Dvcv2Uye.js";function je({auth:$}){const[b,v]=n.useState(!1),[z,B]=n.useState(!0),[O,q]=n.useState(!0),[w,R]=n.useState([]),[C,V]=n.useState([]),[M,F]=n.useState([]),[f,H]=n.useState(""),[j,P]=n.useState(""),[l,_]=n.useState([]),[c,S]=n.useState([]),[o,x]=n.useState({tipo:"venta",fecha_operacion:new Date().toISOString().split("T")[0],porcentaje:5,bank_account_id:"",entidad_financiera:"",numero_operacion_externa:"",notas:""});n.useEffect(()=>{G(),I(),J()},[]);const k=async(a,t,s)=>{try{const r=await N.get(a);t(Array.isArray(r.data)?r.data:r.data.data||[])}catch(r){console.error(`Error cargando datos de ${a}:`,r),t([])}finally{s&&s(!1)}},G=()=>k("/finanzas/factoring/facturas-venta-pendientes",R,B),I=()=>k("/finanzas/factoring/notas-credito-pendientes",V,q),J=async()=>{try{const a=await N.get("/api/contabilidad/bancos");F(Array.isArray(a.data)?a.data:a.data.bancos||[])}catch(a){console.error("Error al cargar bancos:",a),F([])}},K=a=>{_(t=>t.includes(a)?t.filter(s=>s!==a):[...t,a])},Q=a=>{S(t=>t.includes(a)?t.filter(s=>s!==a):[...t,a])},U=()=>{_(l.length===m.length?[]:m.map(a=>a.id))},W=()=>{S(c.length===g.length?[]:g.map(a=>a.id))},X=()=>{const a=w.filter(d=>l.includes(d.id)),t=C.filter(d=>c.includes(d.id)),s=a.reduce((d,p)=>d+parseFloat(p.monto_factorable||p.saldo_pendiente),0),r=t.reduce((d,p)=>d+parseFloat(p.monto||p.total||0),0),u=s-r,i=u*(o.porcentaje/100),h=u-i;return{montoFacturas:s,montoNC:r,montoTotal:u,cargoTotal:i,montoNeto:h,cantidadFacturas:a.length,cantidadNC:t.length}},Y=async a=>{var t,s,r,u;if(a.preventDefault(),l.length===0&&c.length===0){alert("Debe seleccionar al menos una factura o nota de crédito");return}if(!o.bank_account_id)return alert("Debe seleccionar una cuenta bancaria");if(!o.entidad_financiera.trim())return alert("Debe ingresar la entidad financiera");v(!0);try{const i=await N.post("/finanzas/factoring",{...o,facturas_ids:l,notas_credito_ids:c});if(i.status===200||i.status===201){const h=l.length+c.length;alert(`Operación registrada exitosamente (${h} documentos)`),y.visit("/finanzas/factoring")}}catch(i){console.error("Error al registrar:",i);const h=((s=(t=i.response)==null?void 0:t.data)==null?void 0:s.error)||((u=(r=i.response)==null?void 0:r.data)==null?void 0:u.message)||"Error de conexión o servidor";alert(`Error: ${h}`)}finally{v(!1)}},m=w.filter(a=>{var t,s,r;return((t=a.numero_factura)==null?void 0:t.toLowerCase().includes(f.toLowerCase()))||((r=(s=a.cliente)==null?void 0:s.razon_social)==null?void 0:r.toLowerCase().includes(f.toLowerCase()))}),g=C.filter(a=>{var t,s,r;return((t=a.numero_nota)==null?void 0:t.toLowerCase().includes(j.toLowerCase()))||((r=(s=a.cliente)==null?void 0:s.razon_social)==null?void 0:r.toLowerCase().includes(j.toLowerCase()))}),{montoFacturas:Z,montoNC:ee,montoTotal:ae,cargoTotal:te,montoNeto:se}=X();return e.jsxs(ne,{user:$.user,children:[e.jsx(re,{title:"Factoring de Venta - Cargo Financiero"}),e.jsx("div",{className:"py-12",children:e.jsxs("div",{className:"max-w-6xl mx-auto sm:px-6 lg:px-8",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsx("button",{onClick:()=>y.visit("/finanzas/factoring"),className:"text-gray-600 hover:text-gray-900 transition",children:e.jsx(oe,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(A,{className:"w-8 h-8 text-orange-600"}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Factoring de Venta"})]}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Adelanto de cobro con cargo financiero (Selección múltiple agrupada)"})]})]}),e.jsx("div",{className:"bg-orange-50 border-l-4 border-orange-500 p-4 rounded-lg",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(le,{className:"w-5 h-5 text-orange-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-orange-900",children:"Operación con Costo Financiero"}),e.jsx("p",{className:"text-sm text-orange-800 mt-1",children:"Esta operación generará un gasto financiero. El banco cobrará un porcentaje por adelantar el cobro."})]})]})})]}),e.jsxs("form",{onSubmit:Y,className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Seleccionar Facturas de Venta"}),e.jsxs("span",{className:"text-sm text-gray-600",children:[l.length," de ",m.length," seleccionadas"]})]}),z?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex gap-4 mb-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(E,{className:"absolute left-3 top-3 text-gray-400 w-5 h-5 pointer-events-none"}),e.jsx("input",{type:"text",placeholder:"Buscar factura o cliente...",value:f,onChange:a=>H(a.target.value),className:"w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"})]}),e.jsx("button",{type:"button",onClick:U,className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition whitespace-nowrap",children:l.length===m.length?"Deseleccionar todo":"Seleccionar todo"})]}),e.jsx("div",{className:"max-h-96 overflow-y-auto border border-gray-200 rounded-lg",children:m.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No hay facturas pendientes"}):m.map(a=>{var s;const t=l.includes(a.id);return e.jsx("button",{type:"button",onClick:()=>K(a.id),className:`w-full p-4 text-left hover:bg-orange-50 transition border-b border-gray-100 ${t?"bg-orange-100 border-l-4 border-l-orange-600":""}`,children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"mt-1",children:t?e.jsx(D,{className:"w-5 h-5 text-orange-600"}):e.jsx(L,{className:"w-5 h-5 text-gray-400"})}),e.jsxs("div",{className:"flex-1 flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-gray-900",children:a.numero_factura}),e.jsx("div",{className:"text-sm text-gray-600 mt-1",children:(s=a.cliente)==null?void 0:s.razon_social})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-lg font-bold text-gray-900",children:["$",parseFloat(a.saldo_pendiente).toFixed(2)]}),e.jsx("div",{className:"text-xs text-gray-500",children:"Saldo pendiente"})]})]})]})},a.id)})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{className:"w-5 h-5 text-red-600"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Seleccionar Notas de Crédito"})]}),e.jsxs("span",{className:"text-sm text-gray-600",children:[c.length," de ",g.length," seleccionadas"]})]}),O?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex gap-4 mb-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(E,{className:"absolute left-3 top-3 text-gray-400 w-5 h-5 pointer-events-none"}),e.jsx("input",{type:"text",placeholder:"Buscar nota o cliente...",value:j,onChange:a=>P(a.target.value),className:"w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"})]}),e.jsx("button",{type:"button",onClick:W,className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition whitespace-nowrap",children:c.length===g.length?"Deseleccionar todo":"Seleccionar todo"})]}),e.jsx("div",{className:"max-h-96 overflow-y-auto border border-gray-200 rounded-lg",children:g.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No hay notas de crédito pendientes"}):g.map(a=>{var s;const t=c.includes(a.id);return e.jsx("button",{type:"button",onClick:()=>Q(a.id),className:`w-full p-4 text-left hover:bg-red-50 transition border-b border-gray-100 ${t?"bg-red-100 border-l-4 border-l-red-600":""}`,children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"mt-1",children:t?e.jsx(D,{className:"w-5 h-5 text-red-600"}):e.jsx(L,{className:"w-5 h-5 text-gray-400"})}),e.jsxs("div",{className:"flex-1 flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"font-semibold text-gray-900 flex items-center gap-2",children:[e.jsx(T,{className:"w-4 h-4 text-red-600"}),a.numero_nota]}),e.jsx("div",{className:"text-sm text-gray-600 mt-1",children:(s=a.cliente)==null?void 0:s.razon_social})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-lg font-bold text-red-700",children:["-$",parseFloat(a.monto||a.total).toFixed(2)]}),e.jsx("div",{className:"text-xs text-gray-500",children:"Resta del total"})]})]})]})},a.id)})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Detalles de la Operación"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Fecha de Operación *"}),e.jsx("input",{type:"date",value:o.fecha_operacion,onChange:a=>x(t=>({...t,fecha_operacion:a.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Porcentaje de Cargo (%) *"}),e.jsx("input",{type:"number",step:"0.01",min:"0",max:"100",value:o.porcentaje,onChange:a=>x(t=>({...t,porcentaje:a.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Cuenta Bancaria *"}),e.jsxs("select",{value:o.bank_account_id,onChange:a=>x(t=>({...t,bank_account_id:a.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500",required:!0,children:[e.jsx("option",{value:"",children:"Seleccionar banco..."}),M.map(a=>e.jsxs("option",{value:a.id,children:[a.nombre_banco," - ",a.numero_cuenta]},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Entidad Financiera *"}),e.jsx("input",{type:"text",value:o.entidad_financiera,onChange:a=>x(t=>({...t,entidad_financiera:a.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500",placeholder:"Ej: Banco General",required:!0})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"No. Operación Externa"}),e.jsx("input",{type:"text",value:o.numero_operacion_externa,onChange:a=>x(t=>({...t,numero_operacion_externa:a.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500",placeholder:"Ej: FACT-001"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Notas"}),e.jsx("textarea",{value:o.notas,onChange:a=>x(t=>({...t,notas:a.target.value})),rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500",placeholder:"Observaciones..."})]})]})]}),(l.length>0||c.length>0)&&e.jsxs("div",{className:"bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg shadow-sm p-6 border-2 border-orange-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(ce,{className:"w-6 h-6 text-orange-700"}),e.jsx("h3",{className:"text-lg font-semibold text-orange-900",children:"Resumen"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4 mb-4",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Facturas"}),e.jsxs("p",{className:"text-2xl font-bold text-green-700",children:["+$",Z.toFixed(2)]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Notas Crédito"}),e.jsxs("p",{className:"text-2xl font-bold text-red-700",children:["-$",ee.toFixed(2)]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Monto Base"}),e.jsxs("p",{className:"text-2xl font-bold text-gray-900",children:["$",ae.toFixed(2)]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["Cargo (",o.porcentaje,"%)"]}),e.jsxs("p",{className:"text-2xl font-bold text-orange-600",children:["-$",te.toFixed(2)]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border-2 border-orange-500",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"A Recibir"}),e.jsxs("p",{className:"text-2xl font-bold text-orange-700",children:["$",se.toFixed(2)]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx("button",{type:"button",onClick:()=>y.visit("/finanzas/factoring"),className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition",disabled:b,children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:b||l.length===0&&c.length===0,className:"px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition flex items-center gap-2",children:b?"Procesando...":e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"w-5 h-5"}),"Registrar Operación"]})})]})]})]})})]})}export{je as default};
