import{r as l,c as m,j as e,H as B,b as u}from"./app-BqyPfEI0.js";import{A as P}from"./AuthenticatedLayout-ChjIDkpR.js";import{A as O}from"./arrow-left-BzKnOsJ1.js";import{T as y}from"./trending-up-BHd61lWl.js";import{S as R}from"./search-Cu_oT07V.js";import{S as H,a as I}from"./square-CFA_VI6r.js";import{C as M}from"./calculator-BO06dmjd.js";import"./createLucideIcon-DrM2Vc-y.js";function Y({auth:N}){const[x,h]=l.useState(!1),[v,w]=l.useState(!0),[p,b]=l.useState([]),[F,f]=l.useState([]),[g,_]=l.useState(""),[r,j]=l.useState([]),[o,i]=l.useState({tipo:"compra",fecha_operacion:new Date().toISOString().split("T")[0],porcentaje:4,bank_account_id:"",entidad_financiera:"",numero_operacion_externa:"",notas:""});l.useEffect(()=>{S(),C()},[]);const S=async()=>{try{const a=await m.get("/finanzas/factoring/facturas-compra-pendientes");b(Array.isArray(a.data)?a.data:[])}catch(a){console.error("Error al cargar facturas:",a),b([])}finally{w(!1)}},C=async()=>{try{const a=await m.get("/api/contabilidad/bancos");f(Array.isArray(a.data)?a.data:a.data.bancos||[])}catch(a){console.error("Error al cargar bancos:",a),f([])}},k=a=>{j(s=>s.includes(a)?s.filter(t=>t!==a):[...s,a])},D=()=>{j(r.length===c.length?[]:c.map(a=>a.id))},A=()=>{const a=p.filter(d=>r.includes(d.id)),s=a.reduce((d,q)=>d+parseFloat(q.saldo_pendiente),0),t=s*(o.porcentaje/100),n=s-t;return{montoTotal:s,descuentoTotal:t,montoNeto:n,cantidadFacturas:a.length}},T=async a=>{var s,t;if(a.preventDefault(),r.length===0)return alert("Debe seleccionar al menos una factura");if(!o.bank_account_id)return alert("Debe seleccionar una cuenta bancaria");h(!0);try{const n=await m.post("/finanzas/factoring",{...o,facturas_ids:r});(n.status===200||n.status===201)&&(alert(`Operación registrada exitosamente (${r.length} facturas)`),u.visit("/finanzas/factoring"))}catch(n){console.error("Error:",n);const d=((t=(s=n.response)==null?void 0:s.data)==null?void 0:t.error)||"Error de conexión";alert(`Error: ${d}`)}finally{h(!1)}},c=p.filter(a=>{var s,t,n;return((s=a.numero_factura_proveedor)==null?void 0:s.toLowerCase().includes(g.toLowerCase()))||((n=(t=a.proveedor)==null?void 0:t.razon_social)==null?void 0:n.toLowerCase().includes(g.toLowerCase()))}),{montoTotal:E,descuentoTotal:L,montoNeto:z,cantidadFacturas:$}=A();return e.jsxs(P,{user:N.user,children:[e.jsx(B,{title:"Factoring de Compra - Descuento Proveedor"}),e.jsx("div",{className:"py-12",children:e.jsxs("div",{className:"max-w-6xl mx-auto sm:px-6 lg:px-8",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsx("button",{onClick:()=>u.visit("/finanzas/factoring"),className:"text-gray-600 hover:text-gray-900 transition",children:e.jsx(O,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(y,{className:"w-8 h-8 text-green-600"}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Factoring de Compra"})]}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Descuento por pronto pago a proveedor (Selección múltiple agrupada)"})]})]})}),e.jsxs("form",{onSubmit:T,className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Seleccionar Facturas"}),e.jsxs("span",{className:"text-sm text-gray-600",children:[r.length," de ",c.length," seleccionadas"]})]}),v?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex gap-4 mb-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(R,{className:"absolute left-3 top-3 text-gray-400 w-5 h-5 pointer-events-none"}),e.jsx("input",{type:"text",placeholder:"Buscar...",value:g,onChange:a=>_(a.target.value),className:"w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"})]}),e.jsx("button",{type:"button",onClick:D,className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition whitespace-nowrap",children:r.length===c.length?"Deseleccionar todo":"Seleccionar todo"})]}),e.jsx("div",{className:"max-h-96 overflow-y-auto border border-gray-200 rounded-lg",children:c.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No hay facturas"}):c.map(a=>{var t;const s=r.includes(a.id);return e.jsx("button",{type:"button",onClick:()=>k(a.id),className:`w-full p-4 text-left hover:bg-green-50 transition border-b border-gray-100 ${s?"bg-green-100 border-l-4 border-l-green-600":""}`,children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"mt-1",children:s?e.jsx(H,{className:"w-5 h-5 text-green-600"}):e.jsx(I,{className:"w-5 h-5 text-gray-400"})}),e.jsxs("div",{className:"flex-1 flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-gray-900",children:a.numero_factura_proveedor}),e.jsx("div",{className:"text-sm text-gray-600 mt-1",children:(t=a.proveedor)==null?void 0:t.razon_social})]}),e.jsx("div",{className:"text-right",children:e.jsxs("div",{className:"text-lg font-bold text-gray-900",children:["$",parseFloat(a.saldo_pendiente).toFixed(2)]})})]})]})},a.id)})})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Detalles"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Fecha *"}),e.jsx("input",{type:"date",value:o.fecha_operacion,onChange:a=>i(s=>({...s,fecha_operacion:a.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Descuento (%) *"}),e.jsx("input",{type:"number",step:"0.01",value:o.porcentaje,onChange:a=>i(s=>({...s,porcentaje:a.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Banco Pago *"}),e.jsxs("select",{value:o.bank_account_id,onChange:a=>i(s=>({...s,bank_account_id:a.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500",required:!0,children:[e.jsx("option",{value:"",children:"Seleccionar..."}),F.map(a=>e.jsxs("option",{value:a.id,children:[a.nombre_banco," - ",a.numero_cuenta]},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Entidad Financiera"}),e.jsx("input",{type:"text",value:o.entidad_financiera,onChange:a=>i(s=>({...s,entidad_financiera:a.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Notas"}),e.jsx("textarea",{value:o.notas,onChange:a=>i(s=>({...s,notas:a.target.value})),rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"})]})]})]}),r.length>0&&e.jsxs("div",{className:"bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow-sm p-6 border-2 border-green-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(M,{className:"w-6 h-6 text-green-700"}),e.jsx("h3",{className:"text-lg font-semibold text-green-900",children:"Resumen"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Facturas"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:$})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total"}),e.jsxs("p",{className:"text-2xl font-bold text-gray-900",children:["$",E.toFixed(2)]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Descuento"}),e.jsxs("p",{className:"text-2xl font-bold text-green-600",children:["$",L.toFixed(2)]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border-2 border-green-500",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"A Pagar"}),e.jsxs("p",{className:"text-2xl font-bold text-green-700",children:["$",z.toFixed(2)]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx("button",{type:"button",onClick:()=>u.visit("/finanzas/factoring"),className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition",disabled:x,children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:x||r.length===0,className:"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center gap-2",children:x?"Procesando...":e.jsxs(e.Fragment,{children:[e.jsx(y,{className:"w-5 h-5"}),"Registrar Operación"]})})]})]})]})})]})}export{Y as default};
