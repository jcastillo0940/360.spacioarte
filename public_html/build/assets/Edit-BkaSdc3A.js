import{r as i,u as q,j as e,H as v}from"./app-BqyPfEI0.js";import{A as N}from"./AuthenticatedLayout-ChjIDkpR.js";function O({ordenId:u}){const[c,w]=i.useState(null),[y,C]=i.useState([]),[b,k]=i.useState([]),[g,x]=i.useState([]),[S,f]=i.useState(!0),[L,j]=i.useState(""),[E,m]=i.useState(!1),{data:o,setData:n,put:P,processing:_,errors:H}=q({contacto_id:"",fecha_pedido:"",fecha_entrega:"",estado:"",items:[]}),[T,F]=i.useState(0);i.useEffect(()=>{Promise.all([fetch(`/api/compras/ordenes/${u}`).then(s=>s.json()),fetch("/api/compras/ordenes/datos").then(s=>s.json())]).then(([s,a])=>{var t;w(s),C(a.proveedores||[]),k(a.productos||[]),x(a.productos||[]),n({contacto_id:s.contacto_id,fecha_pedido:s.fecha_emision?s.fecha_emision.split("T")[0]:"",fecha_entrega:s.fecha_entrega?s.fecha_entrega.split("T")[0]:"",estado:s.estado,items:((t=s.detalles)==null?void 0:t.map(d=>{var r,l;return{item_id:d.item_id,item_unit_id:d.item_unit_id||"",nombre:(r=d.item)==null?void 0:r.nombre,cantidad:Number(d.cantidad),costo_unitario:Number(d.costo_unitario),unidades_disponibles:((l=d.item)==null?void 0:l.units)||[]}}))||[]}),f(!1)}).catch(s=>{console.error("Error loading data:",s),f(!1)})},[u]);const B=s=>{if(j(s),s.length===0)x(b),m(!1);else{const a=b.filter(t=>t.nombre.toLowerCase().includes(s.toLowerCase())||t.codigo.toLowerCase().includes(s.toLowerCase()));x(a),m(!0)}},I=s=>{var d;const a=o.items.find(r=>r.item_id===s.id),t=((d=s.units)==null?void 0:d.find(r=>r.es_unidad_compra))||null;if(a){const r=o.items.map(l=>l.item_id===s.id?{...l,cantidad:l.cantidad+1}:l);n("items",r)}else{const r={item_id:s.id,item_unit_id:t?t.id:"",nombre:s.nombre,cantidad:1,costo_unitario:t&&t.costo_compra>0?t.costo_compra:s.costo_promedio||0,unidades_disponibles:s.units||[]};n("items",[...o.items,r])}j(""),m(!1)},z=s=>{n("items",o.items.filter(a=>a.item_id!==s))},h=(s,a,t)=>{const d=o.items.map(r=>{if(r.item_id===s){const l={...r,[a]:t};if(a==="item_unit_id"){const p=r.unidades_disponibles.find($=>$.id==t);p&&p.costo_compra>0&&(l.costo_unitario=p.costo_compra)}return(a==="cantidad"||a==="costo_unitario")&&(l[a]=parseFloat(t)||0),l}return r});n("items",d)};i.useEffect(()=>{const s=o.items.reduce((a,t)=>a+t.cantidad*t.costo_unitario,0);F(s)},[o.items]);const R=s=>{s.preventDefault(),P(`/compras/ordenes/${u}`)};return S?e.jsxs(N,{children:[e.jsx(v,{title:"Editando..."}),e.jsx("div",{className:"max-w-7xl mx-auto",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-slate-200 p-12 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto"}),e.jsx("p",{className:"text-slate-600 mt-4",children:"Cargando orden..."})]})})]}):e.jsxs(N,{children:[e.jsx(v,{title:`Editar ${c==null?void 0:c.numero_orden}`}),e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("h1",{className:"text-3xl font-black text-slate-900 flex items-center gap-3",children:[e.jsx("svg",{className:"w-8 h-8 text-slate-700",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),"Editar Orden de Compra"]}),e.jsx("p",{className:"text-slate-600 mt-2 font-mono text-lg",children:c==null?void 0:c.numero_orden})]}),e.jsxs("form",{onSubmit:R,className:"space-y-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-slate-200",children:[e.jsx("h2",{className:"text-lg font-bold mb-4",children:"InformaciÃ³n General"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold uppercase text-slate-500 mb-2",children:"Proveedor *"}),e.jsx("select",{value:o.contacto_id,onChange:s=>n("contacto_id",s.target.value),className:"w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-green-500 focus:ring-1 focus:ring-green-500 transition",required:!0,children:y.map(s=>e.jsx("option",{value:s.id,children:s.razon_social},s.id))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold uppercase text-slate-500 mb-2",children:"Fecha Pedido *"}),e.jsx("input",{type:"date",value:o.fecha_pedido,onChange:s=>n("fecha_pedido",s.target.value),className:"w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-green-500 focus:ring-1 focus:ring-green-500 transition",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold uppercase text-slate-500 mb-2",children:"Fecha Entrega *"}),e.jsx("input",{type:"date",value:o.fecha_entrega,onChange:s=>n("fecha_entrega",s.target.value),className:"w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-green-500 focus:ring-1 focus:ring-green-500 transition",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold uppercase text-slate-500 mb-2",children:"Estado *"}),e.jsxs("select",{value:o.estado,onChange:s=>n("estado",s.target.value),className:"w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-green-500 focus:ring-1 focus:ring-green-500 transition",required:!0,children:[e.jsx("option",{value:"Borrador",children:"Borrador"}),e.jsx("option",{value:"Confirmada",children:"Confirmada"}),e.jsx("option",{value:"Recibida Parcial",children:"Recibida Parcial"}),e.jsx("option",{value:"Recibida Total",children:"Recibida Total"}),e.jsx("option",{value:"Cancelada",children:"Cancelada"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-slate-200",children:[e.jsx("label",{className:"block text-xs font-bold uppercase text-slate-500 mb-2",children:"Buscar Producto"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:L,onChange:s=>B(s.target.value),placeholder:"Buscar...",className:"w-full px-4 py-3 rounded-lg border border-slate-300",autoComplete:"off"}),E&&g.length>0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white border rounded-lg shadow-lg max-h-64 overflow-y-auto",children:g.map(s=>e.jsxs("button",{type:"button",onClick:()=>I(s),className:"w-full text-left p-3 hover:bg-green-50 border-b",children:[e.jsx("div",{className:"font-bold",children:s.nombre}),e.jsx("div",{className:"text-xs text-slate-500",children:s.codigo})]},s.id))})]})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-slate-200",children:[e.jsxs("h2",{className:"text-lg font-bold mb-4",children:["Items (",o.items.length,")"]}),o.items.length===0?e.jsx("p",{className:"text-center text-slate-400 py-8",children:"No hay productos"}):e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"border-b-2",children:e.jsxs("tr",{children:[e.jsx("th",{className:"pb-3 text-left text-xs font-bold uppercase",children:"Producto"}),e.jsx("th",{className:"pb-3 text-left text-xs font-bold uppercase text-slate-600",children:"Unidad"}),e.jsx("th",{className:"pb-3 text-center text-xs font-bold uppercase",children:"Cant."}),e.jsx("th",{className:"pb-3 text-right text-xs font-bold uppercase",children:"Costo"}),e.jsx("th",{className:"pb-3 text-right text-xs font-bold uppercase",children:"Total"}),e.jsx("th",{className:"pb-3"})]})}),e.jsx("tbody",{className:"divide-y",children:o.items.map(s=>{var a;return e.jsxs("tr",{children:[e.jsx("td",{className:"py-3",children:s.nombre}),e.jsx("td",{className:"py-3",children:e.jsxs("select",{className:"w-full text-xs px-2 py-2 border border-slate-300 rounded-lg focus:border-green-500",value:s.item_unit_id,onChange:t=>h(s.item_id,"item_unit_id",t.target.value),children:[e.jsx("option",{value:"",children:"Und. Base"}),(a=s.unidades_disponibles)==null?void 0:a.map(t=>e.jsxs("option",{value:t.id,children:[t.nombre," (x",t.factor_conversion,")"]},t.id))]})}),e.jsx("td",{className:"py-3",children:e.jsx("input",{type:"number",className:"w-20 mx-auto text-center px-2 py-2 border rounded-lg",value:s.cantidad,onChange:t=>h(s.item_id,"cantidad",t.target.value),step:"0.01"})}),e.jsx("td",{className:"py-3",children:e.jsx("input",{type:"number",step:"0.01",className:"w-24 ml-auto text-right px-2 py-2 border rounded-lg",value:s.costo_unitario,onChange:t=>h(s.item_id,"costo_unitario",t.target.value)})}),e.jsxs("td",{className:"py-3 text-right font-bold",children:["$",(s.cantidad*s.costo_unitario).toFixed(2)]}),e.jsx("td",{className:"py-3 text-center",children:e.jsx("button",{type:"button",onClick:()=>z(s.item_id),className:"text-red-500",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})})]},s.item_id)})})]})]})]}),e.jsxs("div",{className:"bg-green-800 text-white p-6 rounded-lg shadow-lg h-fit sticky top-6",children:[e.jsx("h2",{className:"text-lg font-bold mb-6",children:"Total"}),e.jsxs("div",{className:"flex justify-between text-2xl font-black border-t border-green-700 pt-4",children:[e.jsx("span",{children:"Total:"}),e.jsxs("span",{children:["$",T.toFixed(2)]})]}),e.jsx("button",{type:"submit",disabled:_||o.items.length===0,className:"w-full bg-green-600 text-white mt-6 py-4 rounded-lg font-bold hover:bg-green-500 transition disabled:bg-slate-600",children:_?"Guardando...":"Actualizar Orden"})]})]})]})]})]})}export{O as default};
