import{r as n,u as ee,j as e,H as M}from"./app-DUrg3GOp.js";import{A as F}from"./AuthenticatedLayout-C3zTQCkg.js";function ae(){const[I,v]=n.useState([]),[_,N]=n.useState([]),[g,m]=n.useState([]),[O,w]=n.useState([]),[P,f]=n.useState([]),[B,k]=n.useState(!0),[j,y]=n.useState(""),[S,h]=n.useState(!1),{data:l,setData:i,post:q,processing:C,errors:L}=ee({contacto_id:"",sucursal_id:"",vendedor_id:"",fecha_emision:new Date().toISOString().split("T")[0],fecha_entrega:new Date(Date.now()+10080*60*1e3).toISOString().split("T")[0],items:[],imagen_referencia:null}),[T,D]=n.useState(0),[E,V]=n.useState(0),[W,$]=n.useState(0);n.useEffect(()=>{A()},[]);const A=()=>{fetch("/api/ventas/ordenes/datos").then(s=>s.json()).then(s=>{v(s.clientes||[]),N(s.productos||[]),m(s.productos||[]),w(s.vendedores||[]),k(!1)}).catch(s=>{console.error("Error loading data:",s),v([]),N([]),m([]),w([]),k(!1)})},R=s=>{if(!s){f([]),i("sucursal_id","");return}fetch(`/api/inventario/sucursales/contacto/${s}`).then(t=>t.json()).then(t=>{f(t||[]),(t||[]).length>0?i("sucursal_id",t[0].id):i("sucursal_id","")}).catch(t=>{console.error("Error loading sucursales:",t),f([])})},H=s=>{if(y(s),s.length===0)m(_),h(!1);else{const t=_.filter(o=>o.nombre.toLowerCase().includes(s.toLowerCase())||o.codigo.toLowerCase().includes(s.toLowerCase())||o.categoria&&o.categoria.toLowerCase().includes(s.toLowerCase()));m(t),h(!0)}},G=(s,t,o)=>{if(!s.requires_recipe||!t||!o)return null;const r=parseFloat(t.ancho_imprimible||t.ancho||0),a=parseFloat(t.largo_imprimible||t.largo||0),c=parseFloat(s.ancho_imprimible||0),d=parseFloat(s.largo_imprimible||0),p=parseFloat(s.sangrado||0),x=parseFloat(s.separacion_piezas||0);if(r<=0||a<=0||c<=0||d<=0)return null;const u=Math.floor((r-p*2)/(c+x)),X=Math.floor((a-p*2)/(d+x));let b=u*X;if(s.permite_rotacion){const Y=Math.floor((r-p*2)/(d+x)),Z=Math.floor((a-p*2)/(c+x)),z=Y*Z;z>b&&(b=z)}return b>0?b:0},J=s=>{var o,r,a;if(l.items.find(c=>c.item_id===s.id)){const c=l.items.map(d=>d.item_id===s.id?{...d,cantidad:d.cantidad+1}:d);i("items",c)}else{const c={item_id:s.id,nombre:s.nombre,cantidad:1,precio_unitario:s.precio_venta,tasa_itbms:((o=s.tax)==null?void 0:o.tasa)||0,requires_recipe:s.requires_recipe,tipo_impresion:s.tipo_impresion,procesos_compatibles:s.procesos_compatibles||[],papeles_compatibles:s.papeles_compatibles||[],ancho_imprimible:s.ancho_imprimible,largo_imprimible:s.largo_imprimible,sangrado:s.sangrado,separacion_piezas:s.separacion_piezas,permite_rotacion:s.permite_rotacion,proceso_id:((r=s.procesos_compatibles)==null?void 0:r.length)===1?s.procesos_compatibles[0].id:"",material_id:((a=s.papeles_compatibles)==null?void 0:a.length)===1?s.papeles_compatibles[0].id:"",pliegos_necesarios:0,capacidad_por_pliego:0,total_piezas_calculadas:0};i("items",[...l.items,c])}y(""),h(!1)},U=s=>{i("items",l.items.filter(t=>t.item_id!==s))},K=(s,t)=>{const o=l.items.map(r=>r.item_id===s?{...r,cantidad:parseFloat(t)||0}:r);i("items",o)};n.useEffect(()=>{let s=0,t=0;const o=l.items.map(a=>{const c=a.cantidad*a.precio_unitario;if(s+=c,t+=c*(a.tasa_itbms/100),a.requires_recipe&&a.proceso_id&&a.material_id){const d=a.papeles_compatibles.find(u=>u.id==a.material_id),p=a.procesos_compatibles.find(u=>u.id==a.proceso_id),x=G(a,d,p);if(x!==null){const u=Math.ceil(a.cantidad/x);return{...a,capacidad_por_pliego:x,pliegos_necesarios:u,total_piezas_calculadas:a.cantidad}}}return a});JSON.stringify(o)!==JSON.stringify(l.items)&&i("items",o),D(s),V(t),$(s+t)},[l.items]);const Q=s=>{s.preventDefault(),q(route("ordenes.store"))};return B?e.jsxs(F,{children:[e.jsx(M,{title:"Nueva Orden de Venta"}),e.jsx("div",{className:"max-w-7xl mx-auto",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-slate-200 p-12 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"text-slate-600 mt-4",children:"Cargando datos..."})]})})]}):e.jsxs(F,{children:[e.jsx(M,{title:"Nueva Orden de Venta"}),e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx("div",{className:"mb-8",children:e.jsxs("h1",{className:"text-3xl font-black text-slate-900 flex items-center gap-3",children:[e.jsx("svg",{className:"w-8 h-8 text-slate-700",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Nueva Orden de Venta"]})}),e.jsxs("form",{onSubmit:Q,className:"space-y-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-slate-200",children:[e.jsxs("h2",{className:"text-lg font-bold mb-4 flex items-center gap-2",children:[e.jsx("svg",{className:"w-5 h-5 text-slate-700",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})}),"Información General"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold uppercase text-slate-500 mb-2",children:"Cliente *"}),e.jsxs("select",{value:l.contacto_id,onChange:s=>{i("contacto_id",s.target.value),R(s.target.value)},className:"w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition",required:!0,children:[e.jsx("option",{value:"",children:"Seleccione un cliente"}),I.map(s=>e.jsx("option",{value:s.id,children:s.razon_social},s.id))]}),L.contacto_id&&e.jsx("span",{className:"text-red-500 text-xs",children:L.contacto_id})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold uppercase text-slate-500 mb-2",children:"Sucursal"}),e.jsxs("select",{value:l.sucursal_id,onChange:s=>i("sucursal_id",s.target.value),className:"w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition",disabled:!l.contacto_id,children:[e.jsx("option",{value:"",children:"Sucursal principal"}),P.map(s=>e.jsx("option",{value:s.id,children:s.nombre},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold uppercase text-slate-500 mb-2",children:"Vendedor"}),e.jsxs("select",{value:l.vendedor_id,onChange:s=>i("vendedor_id",s.target.value),className:"w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition",children:[e.jsx("option",{value:"",children:"Sin vendedor"}),O.map(s=>e.jsx("option",{value:s.id,children:s.nombre_completo},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold uppercase text-slate-500 mb-2",children:"Fecha Entrega"}),e.jsx("input",{type:"date",value:l.fecha_entrega,onChange:s=>i("fecha_entrega",s.target.value),className:"w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold uppercase text-slate-500 mb-2",children:"Imagen de Referencia"}),e.jsx("input",{type:"file",onChange:s=>i("imagen_referencia",s.target.files[0]),className:"w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition text-xs",accept:"image/*"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-slate-200",children:[e.jsxs("label",{className:"block text-xs font-bold uppercase text-slate-500 mb-2",children:[e.jsx("svg",{className:"w-4 h-4 inline mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),"Buscar Producto"]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:j,onChange:s=>H(s.target.value),onFocus:()=>j&&h(!0),placeholder:"Buscar por nombre, código o categoría...",className:"w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition",autoComplete:"off"}),S&&g.length>0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white border border-slate-300 rounded-lg shadow-lg max-h-64 overflow-y-auto",children:g.map(s=>e.jsx("button",{type:"button",onClick:()=>J(s),className:"w-full text-left p-3 hover:bg-blue-50 border-b border-slate-100 last:border-0 transition",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-bold text-slate-900",children:s.nombre}),e.jsxs("div",{className:"text-xs text-slate-500 mt-1",children:[e.jsx("span",{className:"font-mono",children:s.codigo}),s.categoria&&e.jsxs("span",{className:"ml-2",children:["• ",s.categoria]})]})]}),e.jsxs("div",{className:"text-right ml-4",children:[e.jsxs("div",{className:"font-bold text-blue-600",children:["$",s.precio_venta]}),e.jsxs("div",{className:"text-xs text-slate-500",children:["Stock: ",s.stock_actual||"N/A"]})]})]})},s.id))}),S&&j&&g.length===0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white border border-slate-300 rounded-lg shadow-lg p-4 text-center text-slate-500",children:"No se encontraron productos"})]})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-slate-200",children:[e.jsxs("h2",{className:"text-lg font-bold mb-4 flex items-center gap-2",children:[e.jsx("svg",{className:"w-5 h-5 text-slate-700",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"})}),"Items en la Orden (",l.items.length,")"]}),l.items.length===0?e.jsxs("div",{className:"text-center py-12 text-slate-400",children:[e.jsx("svg",{className:"w-16 h-16 mx-auto mb-4 text-slate-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"})}),e.jsx("p",{className:"font-bold",children:"No hay productos añadidos"}),e.jsx("p",{className:"text-sm mt-1",children:"Usa el buscador para agregar productos"})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"border-b-2 border-slate-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"pb-3 text-left text-xs font-bold uppercase text-slate-600",children:"Producto"}),e.jsx("th",{className:"pb-3 text-center text-xs font-bold uppercase text-slate-600",children:"Cant."}),e.jsx("th",{className:"pb-3 text-right text-xs font-bold uppercase text-slate-600",children:"Precio"}),e.jsx("th",{className:"pb-3 text-right text-xs font-bold uppercase text-slate-600",children:"Subtotal"}),e.jsx("th",{className:"pb-3"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-100",children:l.items.map(s=>e.jsxs("tr",{children:[e.jsxs("td",{className:"py-3",children:[e.jsx("div",{className:"font-medium text-slate-900",children:s.nombre}),s.requires_recipe&&e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2 p-2 bg-slate-50 rounded-lg border border-slate-100",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-[9px] font-black uppercase text-slate-400 mb-1",children:"Máquina"}),e.jsxs("select",{className:"w-full text-[10px] py-1 px-2 rounded border-slate-200 focus:ring-blue-500",value:s.proceso_id,onChange:t=>{const o=l.items.map(r=>r.item_id===s.item_id?{...r,proceso_id:t.target.value}:r);i("items",o)},children:[e.jsx("option",{value:"",children:"Seleccionar..."}),s.procesos_compatibles.map(t=>e.jsx("option",{value:t.id,children:t.nombre},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-[9px] font-black uppercase text-slate-400 mb-1",children:"Papel / Soporte"}),e.jsxs("select",{className:"w-full text-[10px] py-1 px-2 rounded border-slate-200 focus:ring-blue-500",value:s.material_id,onChange:t=>{const o=l.items.map(r=>r.item_id===s.item_id?{...r,material_id:t.target.value}:r);i("items",o)},children:[e.jsx("option",{value:"",children:"Seleccionar..."}),s.papeles_compatibles.map(t=>e.jsx("option",{value:t.id,children:t.nombre},t.id))]})]}),s.capacidad_por_pliego>0&&e.jsxs("div",{className:"col-span-2 flex items-center justify-between mt-1 px-1",children:[e.jsxs("div",{className:"text-[9px] font-bold text-blue-600",children:["Capacidad: ",s.capacidad_por_pliego," pzs/pg"]}),e.jsxs("div",{className:"text-[9px] font-black text-slate-900 bg-white px-2 py-0.5 rounded shadow-sm border border-slate-200",children:["TOTAL PLIEGOS: ",s.pliegos_necesarios]})]})]})]}),e.jsx("td",{className:"py-3",children:e.jsx("input",{type:"number",className:"w-20 mx-auto text-center px-2 py-2 border border-slate-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500",value:s.cantidad,onChange:t=>K(s.item_id,t.target.value),min:"0.01",step:"0.01"})}),e.jsxs("td",{className:"py-3 text-right text-slate-600",children:["$",s.precio_unitario]}),e.jsxs("td",{className:"py-3 text-right font-bold text-slate-900",children:["$",(s.cantidad*s.precio_unitario).toFixed(2)]}),e.jsx("td",{className:"py-3 text-center",children:e.jsx("button",{type:"button",onClick:()=>U(s.item_id),className:"text-red-500 hover:text-red-700 p-1",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})})]},s.item_id))})]})})]})]}),e.jsxs("div",{className:"bg-slate-900 text-white p-6 rounded-lg shadow-lg h-fit sticky top-6",children:[e.jsx("h2",{className:"text-lg font-bold mb-6 text-blue-400",children:"Resumen de Orden"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-slate-400",children:"Subtotal:"}),e.jsxs("span",{className:"font-bold",children:["$",T.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-slate-400",children:"ITBMS (7%):"}),e.jsxs("span",{className:"font-bold",children:["$",E.toFixed(2)]})]}),e.jsx("div",{className:"border-t border-slate-700 pt-3 mt-3",children:e.jsxs("div",{className:"flex justify-between text-2xl font-black",children:[e.jsx("span",{children:"Total:"}),e.jsxs("span",{className:"text-blue-400",children:["$",W.toFixed(2)]})]})})]}),e.jsxs("button",{type:"submit",disabled:C||l.items.length===0||!l.contacto_id,className:"w-full bg-blue-600 text-white mt-6 py-4 rounded-lg font-bold hover:bg-blue-500 transition disabled:bg-slate-600 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}),C?"Procesando...":"Guardar Orden de Venta"]})]})]})]})]})]})}export{ae as default};
