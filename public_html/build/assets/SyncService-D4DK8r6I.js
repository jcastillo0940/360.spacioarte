import{d as e}from"./db-D90IQ0FG.js";import{b as l}from"./app-BfpvEa9J.js";const i=[];for(let n=0;n<256;++n)i.push((n+256).toString(16).slice(1));function w(n,t=0){return(i[n[t+0]]+i[n[t+1]]+i[n[t+2]]+i[n[t+3]]+"-"+i[n[t+4]]+i[n[t+5]]+"-"+i[n[t+6]]+i[n[t+7]]+"-"+i[n[t+8]]+i[n[t+9]]+"-"+i[n[t+10]]+i[n[t+11]]+i[n[t+12]]+i[n[t+13]]+i[n[t+14]]+i[n[t+15]]).toLowerCase()}let u;const g=new Uint8Array(16);function m(){if(!u){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");u=crypto.getRandomValues.bind(crypto)}return u(g)}const v=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),p={randomUUID:v};function h(n,t,s){var o;n=n||{};const a=n.random??((o=n.rng)==null?void 0:o.call(n))??m();if(a.length<16)throw new Error("Random bytes length must be >= 16");return a[6]=a[6]&15|64,a[8]=a[8]&63|128,w(a)}function y(n,t,s){return p.randomUUID&&!n?p.randomUUID():h(n)}const _={async pullData(){try{const n=await l.get("/pwa/sync/initial"),{ruta:t,inventario_vehiculo:s,catalogo:a}=n.data.data;return await e.transaction("rw",e.clientes,e.inventario,e.catalogo,async()=>{await e.clientes.clear(),await e.inventario.clear(),await e.catalogo.clear(),t&&t.clientes&&await e.clientes.bulkPut(t.clientes),s&&await e.inventario.bulkPut(s),a&&await e.catalogo.bulkPut(a)}),console.log("Datos descargados correctamente"),!0}catch(n){return console.error("Error en pullData",n),!1}},async pushData(){try{const n=await e.ordenes_pendientes.where("sincronizado").equals(0).toArray(),t=await e.visitas_pendientes.where("sincronizado").equals(0).toArray();if(n.length===0&&t.length===0)return;const s={ordenes:n,visitas:t},a=await l.post("/pwa/sync/upload",s);a.data.status==="success"&&(await e.transaction("rw",e.ordenes_pendientes,e.visitas_pendientes,async()=>{const o=a.data.synced.ordenes,r=a.data.synced.visitas;if(o){const c=o.map(d=>d.uuid);await e.ordenes_pendientes.where("uuid").anyOf(c).delete()}if(r){const c=r.map(d=>d.uuid);await e.visitas_pendientes.where("uuid").anyOf(c).delete()}}),console.log("SincronizaciÃ³n de subida completada"))}catch(n){console.error("Error en pushData",n)}},async crearOrdenOffline(n,t,s,a="preventa"){const o={uuid:y(),cliente_id:n,items:t,total:s,tipo:a,timestamp:Date.now(),sincronizado:0};await e.ordenes_pendientes.add(o),a==="autoventa"&&t.forEach(async r=>{const c=await e.inventario.get(r.id);c&&await e.inventario.update(r.id,{cantidad:c.cantidad-r.cantidad})})},async registrarVisita(n,t,s,a){const o={uuid:y(),cliente_id:n,lat:t,lng:s,notas:a,timestamp:Date.now(),sincronizado:0};await e.visitas_pendientes.add(o)}};export{_ as S};
