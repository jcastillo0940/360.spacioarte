import{r as i,j as e,H as F,L as A}from"./app-3DoqhR_o.js";import{A as S}from"./AuthenticatedLayout-314zbiSn.js";import{c as P}from"./createLucideIcon-BNyQ3YPG.js";import{P as z}from"./package-DJUCEueF.js";import{C as O}from"./circle-alert-kLNJaXhQ.js";import{D as B}from"./dollar-sign-BiqcBIvO.js";import{P as R}from"./printer-BuKLJ5PB.js";/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["path",{d:"m14.5 12.5-5 5",key:"b62r18"}],["path",{d:"m9.5 12.5 5 5",key:"1rk7el"}]],q=P("file-x",X);/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],J=P("x",H);function K({isOpen:c,onClose:a,facturaId:x,onSuccess:g}){var E;const[m,j]=i.useState(!1),[N,u]=i.useState(!0),[h,w]=i.useState(null),[_,y]=i.useState({}),[o,l]=i.useState({tipo_nota:"devolucion",motivo:"",items:[]}),[v,b]=i.useState({});i.useEffect(()=>{c&&x&&T()},[c,x]);const T=async()=>{u(!0);try{const t=await fetch(`/api/ventas/facturas/${x}/datos-nc`);if(!t.ok)throw new Error(`Error ${t.status}: ${t.statusText}`);const s=await t.json();if(!s.factura||!s.factura.detalles)throw new Error("Los datos de la factura est√°n incompletos");w(s.factura),y(s.cantidades_devueltas||{});const n=s.factura.detalles.map(r=>({item_id:r.item.id,item_nombre:r.item.nombre,item_codigo:r.item.codigo,cantidad_facturada:parseFloat(r.cantidad),cantidad_devuelta:parseFloat(s.cantidades_devueltas[r.item.id]||0),cantidad:0,precio_unitario:parseFloat(r.precio_unitario),devolver_stock:!0,tipo_item:r.item.tipo}));l(r=>({...r,items:n}))}catch(t){console.error("Error al cargar datos:",t),alert(`Error al cargar los datos de la factura: ${t.message}`),a()}finally{u(!1)}},C=t=>{l(s=>{const n=s.items.map(r=>({...r,devolver_stock:t==="devolucion"}));return{...s,tipo_nota:t,items:n}})},M=(t,s)=>{const n=parseFloat(s)||0,r=o.items[t],d=r.cantidad_facturada-r.cantidad_devuelta;if(n>d){b(p=>({...p,[`item_${t}`]:`M√°ximo disponible: ${d.toFixed(2)}`}));return}b(p=>{const f={...p};return delete f[`item_${t}`],f}),l(p=>({...p,items:p.items.map((f,V)=>V===t?{...f,cantidad:n}:f)}))},L=(t,s)=>{l(n=>({...n,items:n.items.map((r,d)=>d===t?{...r,devolver_stock:s}:r)}))},k=()=>o.items.reduce((t,s)=>t+s.cantidad*s.precio_unitario,0),$=()=>k()*.07,D=()=>k()+$(),I=async t=>{t.preventDefault();const s=o.items.filter(n=>n.cantidad>0);if(s.length===0){alert("Debe seleccionar al menos un producto con cantidad mayor a 0");return}if(!o.motivo.trim()){alert("Debe ingresar un motivo para la nota de cr√©dito");return}j(!0);try{const n={factura_venta_id:x,tipo_nota:o.tipo_nota,motivo:o.motivo,items:s.map(d=>({item_id:d.item_id,cantidad:d.cantidad,devolver_stock:d.devolver_stock}))},r=await fetch("/ventas/notas-credito",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify(n)});if(r.ok){const d=await r.json();alert("Nota de cr√©dito creada exitosamente"),g&&g(d),a()}else{const d=await r.json();alert(d.message||"Error al crear la nota de cr√©dito")}}catch(n){console.error("Error:",n),alert("Error al crear la nota de cr√©dito")}finally{j(!1)}};return c?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"px-6 py-4 border-b border-gray-200 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Crear Nota de Cr√©dito"}),h&&e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:["Factura: ",h.numero_factura," - Cliente: ",(E=h.cliente)==null?void 0:E.razon_social]})]}),e.jsx("button",{onClick:a,className:"text-gray-400 hover:text-gray-600 transition",children:e.jsx(J,{className:"w-6 h-6"})})]}),N?e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"})}):e.jsxs("form",{onSubmit:I,className:"flex-1 overflow-y-auto",children:[e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Tipo de Nota de Cr√©dito *"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("button",{type:"button",onClick:()=>C("devolucion"),className:`p-4 rounded-lg border-2 transition ${o.tipo_nota==="devolucion"?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,children:[e.jsx(z,{className:`w-8 h-8 mx-auto mb-2 ${o.tipo_nota==="devolucion"?"text-blue-600":"text-gray-400"}`}),e.jsx("p",{className:"font-semibold text-sm",children:"Devoluci√≥n"}),e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:"Producto regresa al inventario"})]}),e.jsxs("button",{type:"button",onClick:()=>C("merma"),className:`p-4 rounded-lg border-2 transition ${o.tipo_nota==="merma"?"border-red-500 bg-red-50":"border-gray-200 hover:border-gray-300"}`,children:[e.jsx(O,{className:`w-8 h-8 mx-auto mb-2 ${o.tipo_nota==="merma"?"text-red-600":"text-gray-400"}`}),e.jsx("p",{className:"font-semibold text-sm",children:"Merma"}),e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:"Producto da√±ado/perdido"})]}),e.jsxs("button",{type:"button",onClick:()=>C("descuento"),className:`p-4 rounded-lg border-2 transition ${o.tipo_nota==="descuento"?"border-green-500 bg-green-50":"border-gray-200 hover:border-gray-300"}`,children:[e.jsx(B,{className:`w-8 h-8 mx-auto mb-2 ${o.tipo_nota==="descuento"?"text-green-600":"text-gray-400"}`}),e.jsx("p",{className:"font-semibold text-sm",children:"Descuento"}),e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:"Ajuste de precio"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Motivo de la Nota de Cr√©dito *"}),e.jsx("textarea",{value:o.motivo,onChange:t=>l(s=>({...s,motivo:t.target.value})),rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent",placeholder:"Ej: Cliente devuelve productos por defecto de f√°brica",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Productos a Incluir en la NC"}),e.jsx("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Producto"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"Facturado"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"Ya Devuelto"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"Disponible"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"Cantidad NC"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"Devolver Stock"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Subtotal"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:o.items.map((t,s)=>{const n=t.cantidad_facturada-t.cantidad_devuelta;return e.jsxs("tr",{className:t.cantidad>0?"bg-blue-50":"",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:t.item_nombre}),e.jsx("p",{className:"text-xs text-gray-500",children:t.item_codigo})]})}),e.jsx("td",{className:"px-4 py-3 text-center text-sm text-gray-900",children:t.cantidad_facturada.toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-center text-sm text-gray-600",children:t.cantidad_devuelta.toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-center text-sm font-semibold text-green-600",children:n.toFixed(2)}),e.jsxs("td",{className:"px-4 py-3",children:[e.jsx("input",{type:"number",step:"0.01",min:"0",max:n,value:t.cantidad,onChange:r=>M(s,r.target.value),className:"w-24 px-2 py-1 text-center border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 focus:border-transparent"}),v[`item_${s}`]&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:v[`item_${s}`]})]}),e.jsx("td",{className:"px-4 py-3 text-center",children:t.tipo_item==="Inventariable"?e.jsx("label",{className:"inline-flex items-center cursor-pointer",children:e.jsx("input",{type:"checkbox",checked:t.devolver_stock,onChange:r=>L(s,r.target.checked),className:"w-5 h-5 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500"})}):e.jsx("span",{className:"text-xs text-gray-400",children:"N/A"})}),e.jsxs("td",{className:"px-4 py-3 text-right text-sm font-medium text-gray-900",children:["$",(t.cantidad*t.precio_unitario).toFixed(2)]})]},s)})})]})})})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Resumen de la NC"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Subtotal:"}),e.jsxs("span",{className:"font-medium",children:["$",k().toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"ITBMS:"}),e.jsxs("span",{className:"font-medium",children:["$",$().toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold pt-2 border-t border-gray-300",children:[e.jsx("span",{children:"Total:"}),e.jsxs("span",{className:"text-indigo-600",children:["$",D().toFixed(2)]})]})]})]})]}),e.jsxs("div",{className:"px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:a,className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition",disabled:m,children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:m||D()===0,className:"px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed",children:m?"Procesando...":"Crear Nota de Cr√©dito"})]})]})]})}):null}function te({facturaId:c}){var _,y,o;const[a,x]=i.useState(null),[g,m]=i.useState(!0),[j,N]=i.useState(!1),u=()=>{fetch(`/api/ventas/facturas/${c}`).then(l=>l.json()).then(l=>{console.log("Factura cargada:",l),x(l),m(!1)}).catch(l=>{console.error("Error loading factura:",l),m(!1)})};i.useEffect(()=>{u()},[c]);const h=l=>{console.log("Nota de cr√©dito creada:",l),u(),alert("Nota de cr√©dito creada exitosamente")},w=a&&a.saldo_pendiente>0&&a.estado!=="Anulada"&&a.estado!=="Cancelada";return g?e.jsxs(S,{children:[e.jsx(F,{title:"Cargando factura..."}),e.jsx("div",{className:"max-w-5xl mx-auto px-4 py-8",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-slate-200 p-12 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"text-slate-600 mt-4",children:"Cargando factura..."})]})})]}):a?e.jsxs(S,{children:[e.jsx(F,{title:`Factura ${a.numero_factura}`}),e.jsxs("div",{className:"max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsxs("div",{className:"flex justify-between items-center mb-8",children:[e.jsxs("h1",{className:"text-4xl font-black text-slate-900",children:["üìÑ ",a.numero_factura]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(A,{href:"/ventas/facturas",className:"px-6 py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition",children:"‚Üê Volver"}),e.jsxs("button",{onClick:()=>window.print(),className:"px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition inline-flex items-center gap-2",children:[e.jsx(R,{className:"w-5 h-5"}),"Imprimir"]}),w&&e.jsxs("button",{onClick:()=>N(!0),className:"px-6 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition inline-flex items-center gap-2",children:[e.jsx(q,{className:"w-5 h-5"}),"Nota de Cr√©dito"]})]})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-8",children:[e.jsx("div",{className:"mb-6 flex justify-between items-center",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("span",{className:`px-4 py-2 rounded-full font-bold text-sm ${a.estado==="Pagada"?"bg-green-100 text-green-800":a.estado==="Pendiente"?"bg-yellow-100 text-yellow-800":a.estado==="Vencida"?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800"}`,children:a.estado}),a.saldo_pendiente>0&&e.jsxs("span",{className:"px-4 py-2 rounded-full bg-blue-100 text-blue-800 font-bold text-sm",children:["Saldo: $",parseFloat(a.saldo_pendiente).toFixed(2)]})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-8 mb-8 pb-8 border-b border-slate-200",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-black text-slate-900 mb-4",children:"Cliente"}),e.jsx("p",{className:"font-bold text-slate-900",children:((_=a.cliente)==null?void 0:_.razon_social)||"N/A"}),e.jsxs("p",{className:"text-slate-600",children:["RUC: ",((y=a.cliente)==null?void 0:y.identificacion)||"N/A"]}),e.jsx("p",{className:"text-slate-600",children:((o=a.cliente)==null?void 0:o.email)||"N/A"})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("span",{className:"text-sm font-bold text-slate-500 uppercase",children:"Fecha Emisi√≥n"}),e.jsx("p",{className:"text-xl font-bold text-slate-900",children:a.fecha_emision?new Date(a.fecha_emision).toLocaleDateString("es-PA"):"N/A"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-bold text-slate-500 uppercase",children:"Vencimiento"}),e.jsx("p",{className:"text-xl font-bold text-slate-900",children:a.fecha_vencimiento?new Date(a.fecha_vencimiento).toLocaleDateString("es-PA"):"N/A"})]})]})]}),e.jsxs("table",{className:"w-full mb-8",children:[e.jsx("thead",{className:"bg-slate-900 text-white",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left font-black uppercase",children:"Item"}),e.jsx("th",{className:"px-4 py-3 text-right font-black uppercase",children:"Cantidad"}),e.jsx("th",{className:"px-4 py-3 text-right font-black uppercase",children:"Precio"}),e.jsx("th",{className:"px-4 py-3 text-right font-black uppercase",children:"ITBMS"}),e.jsx("th",{className:"px-4 py-3 text-right font-black uppercase",children:"Total"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-200",children:a.detalles&&a.detalles.length>0?a.detalles.map((l,v)=>{var b;return e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-3 font-medium",children:((b=l.item)==null?void 0:b.nombre)||"N/A"}),e.jsx("td",{className:"px-4 py-3 text-right",children:l.cantidad}),e.jsxs("td",{className:"px-4 py-3 text-right",children:["$",parseFloat(l.precio_unitario||0).toFixed(2)]}),e.jsxs("td",{className:"px-4 py-3 text-right",children:[l.porcentaje_itbms,"%"]}),e.jsxs("td",{className:"px-4 py-3 text-right font-bold",children:["$",parseFloat(l.total_item||0).toFixed(2)]})]},v)}):e.jsx("tr",{children:e.jsx("td",{colSpan:"5",className:"px-4 py-8 text-center text-slate-500",children:"No hay detalles en esta factura"})})})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs("div",{className:"w-80 space-y-3",children:[e.jsxs("div",{className:"flex justify-between py-2 border-b border-slate-200",children:[e.jsx("span",{className:"font-bold text-slate-700",children:"Subtotal:"}),e.jsxs("span",{className:"font-bold text-slate-900",children:["$",parseFloat(a.subtotal||0).toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between py-2 border-b border-slate-200",children:[e.jsx("span",{className:"font-bold text-slate-700",children:"ITBMS:"}),e.jsxs("span",{className:"font-bold text-slate-900",children:["$",parseFloat(a.itbms_total||0).toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between py-3 bg-slate-900 text-white px-4 rounded-xl",children:[e.jsx("span",{className:"font-black text-xl",children:"TOTAL:"}),e.jsxs("span",{className:"font-black text-2xl",children:["$",parseFloat(a.total||0).toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between py-2",children:[e.jsx("span",{className:"font-bold text-blue-700",children:"Saldo Pendiente:"}),e.jsxs("span",{className:"font-bold text-blue-700 text-xl",children:["$",parseFloat(a.saldo_pendiente||0).toFixed(2)]})]})]})})]})]}),e.jsx(K,{isOpen:j,onClose:()=>N(!1),facturaId:a.id,onSuccess:h})]}):e.jsxs(S,{children:[e.jsx(F,{title:"Factura no encontrada"}),e.jsx("div",{className:"max-w-5xl mx-auto px-4 py-8",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-slate-200 p-12 text-center",children:[e.jsx("p",{className:"text-slate-600",children:"Factura no encontrada"}),e.jsx(A,{href:"/ventas/facturas",className:"mt-4 inline-block px-6 py-3 bg-slate-900 text-white rounded-lg font-bold",children:"‚Üê Volver a Facturas"})]})})]})}export{te as default};
