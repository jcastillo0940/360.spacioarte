import{r,j as e,H as D,a as w}from"./app-BfpvEa9J.js";import{A as M}from"./AuthenticatedLayout-BAkMyy8i.js";function F({auth:C,orden:i,recepcionesPrevias:u=[]}){var _;const[a,l]=r.useState([]),[x,j]=r.useState(""),[f,R]=r.useState(""),[p,k]=r.useState("parcial"),[h,E]=r.useState(!1),[N,y]=r.useState(!1),[g,c]=r.useState(""),b=r.useRef(null);r.useEffect(()=>{b.current&&b.current.focus()},[a]);const v=async()=>{if(x.trim()){y(!0),c("Buscando producto...");try{const s=await(await fetch(route("compras.recepciones.buscar-codigo"),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({codigo:x,orden_id:i.id})})).json();s.success?(S(s.item,s.detalle_orden),c(`✓ ${s.item.nombre} agregado`),setTimeout(()=>c(""),2e3)):(c("✗ Producto no encontrado en esta orden"),setTimeout(()=>c(""),3e3))}catch(t){console.error("Error buscando producto:",t),c("✗ Error al buscar producto"),setTimeout(()=>c(""),3e3)}finally{j(""),y(!1)}}},S=(t,s)=>{const d=a.find(n=>n.item_id===t.id);if(d){const n=d.cantidad_recibida+1;n<=s.cantidad_pendiente?l(m=>m.map(o=>o.item_id===t.id?{...o,cantidad_recibida:n}:o)):alert(`No puedes recibir más de ${s.cantidad_pendiente} unidades de este producto`)}else l([...a,{item_id:t.id,nombre:t.nombre,codigo:t.codigo,cantidad_ordenada:s.cantidad_ordenada,cantidad_pendiente:s.cantidad_pendiente,cantidad_recibida:1,costo_unitario:Number(s.costo_unitario||0)}])},P=t=>{a.find(s=>s.item_id===t.item.id)||l([...a,{item_id:t.item.id,nombre:t.item.nombre,codigo:t.item.codigo,cantidad_ordenada:t.cantidad,cantidad_pendiente:t.cantidad_pendiente,cantidad_recibida:0,costo_unitario:Number(t.costo_unitario||0)}])},A=(t,s)=>{const d=a.find(m=>m.item_id===t);if(!d)return;const n=parseFloat(s)||0;if(!(n<0)){if(n>d.cantidad_pendiente){alert(`No puedes recibir más de ${d.cantidad_pendiente} unidades`);return}l(m=>m.map(o=>o.item_id===t?{...o,cantidad_recibida:n}:o))}},T=t=>{l(s=>s.filter(d=>d.item_id!==t))},L=()=>a.reduce((t,s)=>t+s.cantidad_recibida*s.costo_unitario,0),$=()=>{const t=a.filter(s=>s.cantidad_recibida>0);if(t.length===0){alert("Debes agregar al menos un producto con cantidad mayor a 0");return}confirm(`¿Confirmar recepción ${p}?`)&&w.post(route("compras.recepciones.store"),{orden_compra_id:i.id,tipo_recepcion:p,observaciones:f,items:t.map(s=>({item_id:s.item_id,cantidad_recibida:s.cantidad_recibida}))})};return e.jsxs(M,{user:C.user,header:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h2",{className:"font-semibold text-xl text-gray-800 leading-tight",children:["Recibir Orden: ",i.numero_orden]}),e.jsx("button",{onClick:()=>w.visit(route("compras.recepciones.index")),className:"px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition",children:"← Volver"})]}),children:[e.jsx(D,{title:`Recibir ${i.numero_orden}`}),e.jsx("div",{className:"py-6",children:e.jsxs("div",{className:"max-w-7xl mx-auto sm:px-6 lg:px-8 space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Proveedor"}),e.jsx("p",{className:"font-semibold text-gray-900",children:((_=i.proveedor)==null?void 0:_.razon_social)||"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Fecha de Entrega"}),e.jsx("p",{className:"font-semibold text-gray-900",children:i.fecha_entrega?new Date(i.fecha_entrega).toLocaleDateString("es-ES"):"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Total de la Orden"}),e.jsxs("p",{className:"font-semibold text-gray-900",children:["$",Number(i.total||0).toFixed(2)]})]})]}),u.length>0&&e.jsxs("button",{onClick:()=>E(!h),className:"mt-4 text-sm text-blue-600 hover:text-blue-800 flex items-center",children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})}),h?"Ocultar":"Ver"," recepciones previas (",u.length,")"]})]}),h&&e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-6 animate-fade-in",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:"Recepciones Anteriores"}),e.jsx("div",{className:"space-y-3",children:u.map(t=>{var s;return e.jsxs("div",{className:"bg-white rounded p-4 shadow-sm flex justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:t.numero_recepcion}),e.jsx("p",{className:"text-xs text-gray-500",children:new Date(t.fecha_recepcion).toLocaleString()})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-sm font-bold",children:[t.cantidad_total_items," items"]}),e.jsxs("p",{className:"text-xs text-gray-400",children:["Por: ",(s=t.usuario)==null?void 0:s.name]})]})]},t.id)})})]}),e.jsxs("div",{className:"bg-blue-600 rounded-lg shadow-lg p-6 text-white",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Escanear Producto"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("input",{ref:b,type:"text",value:x,onChange:t=>j(t.target.value),onKeyPress:t=>t.key==="Enter"&&v(),placeholder:"Escanea el código de barras...",disabled:N,className:"flex-1 px-4 py-3 text-gray-900 rounded-lg focus:ring-2 focus:ring-blue-300 outline-none"}),e.jsx("button",{onClick:v,className:"px-6 py-3 bg-white text-blue-600 font-bold rounded-lg hover:bg-blue-50 transition disabled:opacity-50",disabled:N||!x.trim(),children:"Buscar"})]}),g&&e.jsx("div",{className:`mt-3 p-2 rounded text-center text-sm font-bold ${g.includes("✓")?"bg-green-500":"bg-red-500"}`,children:g})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-100",children:e.jsx("h3",{className:"font-bold text-gray-700",children:"Productos Disponibles en Orden"})}),e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Producto"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Ordenado"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Pendiente"}),e.jsx("th",{className:"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"Acción"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:i.detalles.map(t=>e.jsxs("tr",{children:[e.jsxs("td",{className:"px-6 py-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.item.nombre}),e.jsx("div",{className:"text-xs text-gray-500",children:t.item.codigo})]}),e.jsx("td",{className:"px-6 py-4 text-right text-sm",children:t.cantidad}),e.jsx("td",{className:"px-6 py-4 text-right text-sm font-bold text-orange-600",children:t.cantidad_pendiente}),e.jsx("td",{className:"px-6 py-4 text-center",children:t.cantidad_pendiente>0&&!a.find(s=>s.item_id===t.item.id)&&e.jsx("button",{onClick:()=>P(t),className:"text-blue-600 hover:text-blue-900 text-sm font-bold",children:"+ Añadir"})})]},t.id))})]})]}),a.length>0&&e.jsxs("div",{className:"bg-white rounded-lg shadow-md border-t-4 border-green-500 p-6",children:[e.jsx("h3",{className:"text-lg font-bold mb-4",children:"Items a Ingresar"}),e.jsx("div",{className:"space-y-3",children:a.map(t=>e.jsxs("div",{className:"flex flex-wrap items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"w-full md:w-auto mb-2 md:mb-0",children:[e.jsx("p",{className:"font-bold text-gray-800",children:t.nombre}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Pendiente: ",t.cantidad_pendiente]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"number",value:t.cantidad_recibida,onChange:s=>A(t.item_id,s.target.value),className:"w-24 rounded border-gray-300",step:"0.01"}),e.jsx("div",{className:"text-right min-w-[100px]",children:e.jsxs("p",{className:"text-sm font-bold text-gray-900",children:["$",(t.cantidad_recibida*t.costo_unitario).toFixed(2)]})}),e.jsx("button",{onClick:()=>T(t.item_id),className:"text-red-500 hover:text-red-700",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})})]})]},t.item_id))}),e.jsxs("div",{className:"mt-6 border-t pt-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("span",{className:"text-gray-600",children:"Total recepción:"}),e.jsxs("span",{className:"text-2xl font-black text-green-600",children:["$",L().toFixed(2)]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold mb-1",children:"Tipo de Cierre"}),e.jsxs("select",{value:p,onChange:t=>k(t.target.value),className:"w-full rounded border-gray-300",children:[e.jsx("option",{value:"parcial",children:"Recepción Parcial (Quedan pendientes)"}),e.jsx("option",{value:"completa",children:"Recepción Completa (Cerrar orden)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold mb-1",children:"Notas"}),e.jsx("input",{type:"text",value:f,onChange:t=>R(t.target.value),className:"w-full rounded border-gray-300",placeholder:"Opcional..."})]})]}),e.jsx("button",{onClick:$,className:"w-full py-4 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 shadow-lg transition-transform active:scale-95",children:"PROCESAR ENTRADA DE ALMACÉN"})]})]})]})})]})}export{F as default};
