import{r as n,j as e,H as z,a as y}from"./app-C7fXC9xy.js";import{A as H}from"./AuthenticatedLayout-DSgvOGZX.js";import{A as U}from"./arrow-left-DjrG7TZ6.js";import{S as W}from"./search-4ZQwLrAH.js";import{C as B}from"./circle-x-iPY3venu.js";import{P as O}from"./package-BDDOr0yo.js";import{C as G}from"./circle-alert-ChTw9Z6N.js";import{D as J}from"./dollar-sign-CDakCBXH.js";import{P as K}from"./plus-Hw3faUKz.js";import{F as Q}from"./file-text-BMeWe_Rp.js";import{T as V}from"./trash-2-BxnEhRUA.js";import"./createLucideIcon-Br14Htuj.js";function me({auth:E}){var F,q;const[f,v]=n.useState(!1),[u,N]=n.useState([]),[x,g]=n.useState([]),[c,_]=n.useState([]),[d,h]=n.useState(""),[w,Y]=n.useState(""),[r,i]=n.useState({es_manual:!0,factura_manual_ref:"",fecha_factura_original:"",contacto_id:"",sucursal_id:"",tipo_nota:"devolucion",motivo:"",es_merma:!1,items:[]}),[o,C]=n.useState({});n.useEffect(()=>{L(),D()},[]);const L=async()=>{try{const s=await(await fetch("/api/inventario/contactos",{credentials:"include",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}})).json();N(Array.isArray(s.contactos)?s.contactos:[])}catch(t){console.error("Error al cargar contactos:",t),N([])}},D=async()=>{try{const s=await(await fetch("/api/inventario/items",{credentials:"include",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}})).json();_(Array.isArray(s.items)?s.items:[])}catch(t){console.error("Error al cargar items:",t),_([])}},I=async t=>{if(!t){g([]);return}try{const a=await(await fetch(`/api/inventario/sucursales/contacto/${t}`,{credentials:"include",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}})).json();g(Array.isArray(a)?a:[])}catch(s){console.error("Error al cargar sucursales:",s),g([])}},j=t=>{i(s=>({...s,tipo_nota:t,es_merma:t==="merma"}))},M=()=>{i(t=>({...t,items:[...t.items,{item_id:"",cantidad:0,precio_unitario:0,devolver_stock:!0}]}))},R=t=>{i(s=>({...s,items:s.items.filter((a,l)=>l!==t)}))},m=(t,s,a)=>{i(l=>({...l,items:l.items.map((p,b)=>b===t?{...p,[s]:a}:p)}))},$=(t,s)=>{const a=c.find(l=>l.id===parseInt(s));a&&(m(t,"item_id",s),m(t,"precio_unitario",a.precio_venta))},S=()=>r.items.reduce((t,s)=>t+parseFloat(s.cantidad||0)*parseFloat(s.precio_unitario||0),0),k=()=>r.items.reduce((t,s)=>{var b;const a=c.find(X=>X.id===parseInt(s.item_id)),l=((b=a==null?void 0:a.tax)==null?void 0:b.tasa)||0,p=parseFloat(s.cantidad||0)*parseFloat(s.precio_unitario||0);return t+p*(l/100)},0),P=()=>S()+k(),T=async t=>{if(t.preventDefault(),!r.factura_manual_ref.trim()){alert("Debe ingresar el n√∫mero de factura manual");return}if(!r.contacto_id){alert("Debe seleccionar un cliente");return}if(r.items.length===0){alert("Debe agregar al menos un producto");return}if(x.length>0&&!r.sucursal_id){alert("Debe seleccionar una sucursal");return}if(!r.motivo.trim()){alert("Debe ingresar un motivo");return}v(!0),C({}),y.post("/ventas/notas-credito",r,{preserveState:!0,preserveScroll:!0,onSuccess:()=>{alert("Nota de cr√©dito manual creada exitosamente")},onError:s=>{console.error("Errores de validaci√≥n:",s),C(s);const a=Object.values(s)[0];a&&alert(Array.isArray(a)?a[0]:a)},onFinish:()=>{v(!1)}})},A=Array.isArray(u)?u.filter(t=>{var s,a;return((s=t.razon_social)==null?void 0:s.toLowerCase().includes(d.toLowerCase()))||((a=t.identificacion)==null?void 0:a.toLowerCase().includes(d.toLowerCase()))}):[];return Array.isArray(c)&&c.filter(t=>{var s,a;return((s=t.nombre)==null?void 0:s.toLowerCase().includes(w.toLowerCase()))||((a=t.codigo)==null?void 0:a.toLowerCase().includes(w.toLowerCase()))}),e.jsxs(H,{user:E.user,children:[e.jsx(z,{title:"Crear Nota de Cr√©dito Manual"}),e.jsx("div",{className:"py-12",children:e.jsxs("div",{className:"max-w-7xl mx-auto sm:px-6 lg:px-8",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsx("button",{onClick:()=>y.visit("/ventas/notas-credito"),className:"text-gray-600 hover:text-gray-900 transition",children:e.jsx(U,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Nota de Cr√©dito Manual"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Para facturas f√≠sicas o manuales ya pagadas"})]})]})}),e.jsxs("form",{onSubmit:T,className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Referencia de Factura Manual"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"N√∫mero de Factura Manual *"}),e.jsx("input",{type:"text",value:r.factura_manual_ref,onChange:t=>i(s=>({...s,factura_manual_ref:t.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent",placeholder:"Ej: FAC-2024-001234",required:!0}),o.factura_manual_ref&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:o.factura_manual_ref})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Fecha de Factura Original *"}),e.jsx("input",{type:"date",value:r.fecha_factura_original,onChange:t=>i(s=>({...s,fecha_factura_original:t.target.value})),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent",required:!0}),o.fecha_factura_original&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:o.fecha_factura_original})]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Cliente *"}),e.jsxs("div",{className:"relative",children:[e.jsx(W,{className:"absolute left-3 top-3 text-gray-400 w-5 h-5 pointer-events-none"}),e.jsx("input",{type:"text",placeholder:"Escriba para buscar cliente por nombre o RUC...",value:d,onChange:t=>h(t.target.value),onFocus:()=>h(""),className:"w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-base"}),d&&A.length>0&&e.jsx("div",{className:"absolute z-10 w-full mt-2 bg-white border border-gray-300 rounded-lg shadow-lg max-h-64 overflow-y-auto",children:A.map(t=>e.jsxs("button",{type:"button",onClick:()=>{i(s=>({...s,contacto_id:t.id,sucursal_id:""})),h(`${t.razon_social} - ${t.identificacion}`),I(t.id)},className:"w-full px-4 py-3 text-left hover:bg-indigo-50 transition border-b border-gray-100 last:border-0",children:[e.jsx("div",{className:"font-semibold text-gray-900",children:t.razon_social}),e.jsxs("div",{className:"text-sm text-gray-500",children:[t.tipo," - RUC: ",t.identificacion]})]},t.id))}),r.contacto_id&&!d.includes("-")&&e.jsx("div",{className:"mt-3 p-4 bg-indigo-50 border border-indigo-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-indigo-900",children:(F=u.find(t=>t.id===parseInt(r.contacto_id)))==null?void 0:F.razon_social}),e.jsxs("div",{className:"text-sm text-indigo-700",children:["RUC: ",(q=u.find(t=>t.id===parseInt(r.contacto_id)))==null?void 0:q.identificacion]})]}),e.jsx("button",{type:"button",onClick:()=>{i(t=>({...t,contacto_id:"",sucursal_id:""})),h(""),g([])},className:"text-indigo-600 hover:text-indigo-800",children:e.jsx(B,{className:"w-6 h-6"})})]})}),r.contacto_id&&x.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Sucursal del Cliente *"}),e.jsxs("select",{value:r.sucursal_id,onChange:t=>i(s=>({...s,sucursal_id:t.target.value})),className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent",required:x.length>0,children:[e.jsx("option",{value:"",children:"Seleccione una sucursal..."}),x.map(t=>e.jsxs("option",{value:t.id,children:[t.nombre," - ",t.direccion]},t.id))]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"üìä Esto permite rastrear qu√© sucursales generan m√°s devoluciones"}),o.sucursal_id&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:o.sucursal_id})]}),o.contacto_id&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:o.contacto_id})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Tipo de Nota de Cr√©dito *"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("button",{type:"button",onClick:()=>j("devolucion"),className:`p-4 rounded-lg border-2 transition ${r.tipo_nota==="devolucion"?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,children:[e.jsx(O,{className:`w-8 h-8 mx-auto mb-2 ${r.tipo_nota==="devolucion"?"text-blue-600":"text-gray-400"}`}),e.jsx("p",{className:"font-semibold text-sm",children:"Devoluci√≥n"}),e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:"Producto regresa"})]}),e.jsxs("button",{type:"button",onClick:()=>j("merma"),className:`p-4 rounded-lg border-2 transition ${r.tipo_nota==="merma"?"border-red-500 bg-red-50":"border-gray-200 hover:border-gray-300"}`,children:[e.jsx(G,{className:`w-8 h-8 mx-auto mb-2 ${r.tipo_nota==="merma"?"text-red-600":"text-gray-400"}`}),e.jsx("p",{className:"font-semibold text-sm",children:"Merma"}),e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:"Producto da√±ado"})]}),e.jsxs("button",{type:"button",onClick:()=>j("descuento"),className:`p-4 rounded-lg border-2 transition ${r.tipo_nota==="descuento"?"border-green-500 bg-green-50":"border-gray-200 hover:border-gray-300"}`,children:[e.jsx(J,{className:`w-8 h-8 mx-auto mb-2 ${r.tipo_nota==="descuento"?"text-green-600":"text-gray-400"}`}),e.jsx("p",{className:"font-semibold text-sm",children:"Descuento"}),e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:"Ajuste precio"})]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Motivo de la Nota de Cr√©dito *"}),e.jsx("textarea",{value:r.motivo,onChange:t=>i(s=>({...s,motivo:t.target.value})),rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent",placeholder:"Ej: Cliente devuelve productos por defecto de f√°brica",required:!0}),o.motivo&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:o.motivo})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Productos"}),e.jsxs("button",{type:"button",onClick:M,className:"inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition",children:[e.jsx(K,{className:"w-5 h-5 mr-2"}),"Agregar Producto"]})]}),r.items.length===0?e.jsxs("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:[e.jsx(Q,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"No hay productos agregados"})]}):e.jsx("div",{className:"space-y-4",children:r.items.map((t,s)=>e.jsxs("div",{className:"border border-gray-200 rounded-lg p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Producto *"}),e.jsxs("select",{value:t.item_id,onChange:a=>$(s,a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500",required:!0,children:[e.jsx("option",{value:"",children:"Seleccionar..."}),c.map(a=>e.jsxs("option",{value:a.id,children:[a.codigo," - ",a.nombre]},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Cantidad *"}),e.jsx("input",{type:"number",step:"0.01",min:"0.01",value:t.cantidad,onChange:a=>m(s,"cantidad",a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Precio Unit. *"}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:t.precio_unitario,onChange:a=>m(s,"precio_unitario",a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500",required:!0})]}),e.jsx("div",{className:"flex items-end",children:e.jsx("button",{type:"button",onClick:()=>R(s),className:"w-full px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition",children:e.jsx(V,{className:"w-5 h-5 mx-auto"})})})]}),e.jsx("div",{className:"mt-3 flex items-center",children:e.jsxs("label",{className:"inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:t.devolver_stock,onChange:a=>m(s,"devolver_stock",a.target.checked),className:"w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500"}),e.jsx("span",{className:"ml-2 text-sm text-gray-700",children:"Devolver al inventario"})]})})]},s))}),o.items&&e.jsx("p",{className:"text-red-500 text-xs mt-2",children:o.items})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Resumen"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Subtotal:"}),e.jsxs("span",{className:"font-medium",children:["$",S().toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"ITBMS:"}),e.jsxs("span",{className:"font-medium",children:["$",k().toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold pt-2 border-t border-gray-300",children:[e.jsx("span",{children:"Total:"}),e.jsxs("span",{className:"text-indigo-600",children:["$",P().toFixed(2)]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx("button",{type:"button",onClick:()=>y.visit("/ventas/notas-credito"),className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition",disabled:f,children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:f||r.items.length===0,className:"px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed",children:f?"Creando...":"Crear Nota de Cr√©dito Manual"})]})]})]})})]})}export{me as default};
